-- ================= CONFIG =================
local MAX_SERVERS = 5
local MIN_JOIN_VALUE = 200e6 -- 150M m√≠nimo para mostrar JOIN

-- ================= SETUP =================
local player = game.Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")

local petMenu
repeat
	petMenu = PlayerGui:FindFirstChild("PetMenu")
	task.wait()
until petMenu

local mainFrame = petMenu:WaitForChild("Frame")
local scrolling = mainFrame:WaitForChild("ScrollingFrame")

local usados = {} -- ignorados persistentes
local joinLock = false -- üîí FIX anti-spam JOIN

-- üîπüîπüîπ A√ëADIDO: servidores ya visitados (por JobId)
local servidoresVisitados = {}

-- ================= PERSISTENCIA =================
local FILE_NAME = "auto_join_usados.json"
local HttpService = game:GetService("HttpService")

local function cargarUsados()
	if isfile(FILE_NAME) then
		local ok, data = pcall(function()
			return HttpService:JSONDecode(readfile(FILE_NAME))
		end)
		if ok and type(data) == "table" then
			usados = data
		end
	end
end

local function guardarUsados()
	pcall(function()
		writefile(FILE_NAME, HttpService:JSONEncode(usados))
	end)
end

cargarUsados()

-- marcar el servidor actual como visitado (NO AFECTA AUTOJOIN)
if game.JobId and game.JobId ~= "" then
	servidoresVisitados[game.JobId] = true
end

-- ================= UTILS =================
local function parseValor(txt)
	if not txt then return nil end
	txt = txt:gsub("%s+", "")

	local maxValue = nil
	for num, suf in txt:gmatch("([%d%.]+)([MB])") do
		local n = tonumber(num)
		if n then
			local value = (suf == "B" and n * 1e9) or (suf == "M" and n * 1e6)
			if value and (not maxValue or value > maxValue) then
				maxValue = value
			end
		end
	end
	return maxValue
end

-- ================= GUI =================
local gui = Instance.new("ScreenGui")
gui.Name = "AUTO_JOIN_GUI"
gui.ResetOnSpawn = false
gui.DisplayOrder = 999999
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
gui.Enabled = true
gui.Parent = PlayerGui

local bigBtn = Instance.new("TextButton")
bigBtn.Size = UDim2.new(0,260,0,90)
bigBtn.Position = UDim2.new(1,-280,0.5,-45)
bigBtn.BackgroundColor3 = Color3.fromRGB(0,170,0)
bigBtn.TextColor3 = Color3.new(1,1,1)
bigBtn.TextScaled = true
bigBtn.Font = Enum.Font.SourceSansBold
bigBtn.Visible = false
bigBtn.Parent = gui

local listFrame = Instance.new("Frame")
listFrame.Size = UDim2.new(0,260,0,150)
listFrame.Position = UDim2.new(1,-280,0.5,-210)
listFrame.BackgroundColor3 = Color3.fromRGB(35,35,35)
listFrame.Visible = false
listFrame.Parent = gui

Instance.new("UICorner", listFrame).CornerRadius = UDim.new(0,12)

local listScroll = Instance.new("ScrollingFrame")
listScroll.Size = UDim2.new(1,-8,1,-8)
listScroll.Position = UDim2.new(0,4,0,4)
listScroll.CanvasSize = UDim2.new(0,0,0,0)
listScroll.ScrollBarImageTransparency = 0.3
listScroll.Parent = listFrame

local layout = Instance.new("UIListLayout", listScroll)
layout.Padding = UDim.new(0,6)
layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
	listScroll.CanvasSize = UDim2.new(0,0,0,layout.AbsoluteContentSize.Y + 6)
end)

-- ================= CORE =================
local function limpiarLista()
	for _,c in ipairs(listScroll:GetChildren()) do
		if c:IsA("TextButton") then
			c:Destroy()
		end
	end
end

local function escanear()
	limpiarLista()

	local lista = {}
	local vistos = 0

	for _,obj in ipairs(scrolling:GetChildren()) do
		if obj:IsA("Frame") then
			local lbl = obj:FindFirstChildWhichIsA("TextLabel")
			if lbl then
				local valor = parseValor(lbl.Text)
				if valor then
					vistos += 1
					if vistos <= MAX_SERVERS then
						table.insert(lista,{
							frame = obj,
							valor = valor,
							texto = lbl.Text,
							firma = lbl.Text
						})
					end
				end
			end
		end
		if vistos >= MAX_SERVERS then break end
	end

	if vistos < MAX_SERVERS then return end
	if #lista == 0 then
		bigBtn.Visible = false
		listFrame.Visible = false
		return
	end

	table.sort(lista,function(a,b)
		return a.valor > b.valor
	end)

	listFrame.Visible = true

	for _,srv in ipairs(lista) do
		local item = Instance.new("TextButton")
		item.Size = UDim2.new(1,-6,0,32)
		item.Text = srv.texto
		item.TextScaled = true
		item.Font = Enum.Font.SourceSans
		item.BackgroundColor3 = usados[srv.firma]
			and Color3.fromRGB(90,40,40)
			or Color3.fromRGB(60,60,60)
		item.TextColor3 = Color3.new(1,1,1)
		item.Parent = listScroll

		item.MouseButton1Click:Connect(function()
			if usados[srv.firma] then
				usados[srv.firma] = nil
			else
				usados[srv.firma] = true
			end
			guardarUsados()
			escanear()
		end)
	end

	bigBtn.Visible = false

	for _,srv in ipairs(lista) do
	if not usados[srv.firma]
		and srv.valor >= MIN_JOIN_VALUE then


			bigBtn.Text = "JOIN " .. srv.texto
			bigBtn.Visible = true

			for _,c in ipairs(getconnections(bigBtn.MouseButton1Click)) do
				c:Disable()
			end

			bigBtn.MouseButton1Click:Connect(function()
	if joinLock then return end
	joinLock = true
	bigBtn.Visible = false

	local inner = srv.frame:FindFirstChildWhichIsA("Frame")
	if not inner then joinLock = false return end

	local joinBtn = inner:FindFirstChildWhichIsA("TextButton")
	if not joinBtn then joinLock = false return end

	-- ‚úÖ MARCAR COMO USADO ANTES DE SALIR
	usados[srv.firma] = true
	guardarUsados()

	-- (opcional, no rompe nada)
	if game.JobId and game.JobId ~= "" then
		servidoresVisitados[game.JobId] = true
	end

	-- ‚úÖ JOIN REAL
	for _,conn in ipairs(getconnections(joinBtn.MouseButton1Click)) do
		conn:Fire()
	end

task.delay(0.5, function()
	joinLock = false
end)


			return
		end
	end
end

-- ================= TRIGGER =================
scrolling.ChildAdded:Connect(function()
	task.wait()
	escanear()
end)

-- ================= AUTO REFRESH GUI =================

-- buscar el bot√≥n Refresh del PetMenu
local function getRefreshButton()
	for _,obj in ipairs(mainFrame:GetDescendants()) do
		if obj:IsA("TextButton") then
			if obj.Text == "Refresh" or obj.ContentText == "Refresh" then
				return obj
			end
		end
	end
end

-- disparar el refresh real
local function fireRefresh()
	local btn = getRefreshButton()
	if not btn then return end

	for _,conn in ipairs(getconnections(btn.MouseButton1Click)) do
		conn:Fire()
	end
end

-- ================= GUI AUTO REFRESH =================

local refreshGui = Instance.new("Frame")
refreshGui.Size = UDim2.new(0,160,0,90)
refreshGui.Position = UDim2.new(1,-450,0.5,-45) -- a la IZQUIERDA del panel
refreshGui.BackgroundColor3 = Color3.fromRGB(30,30,30)
refreshGui.Active = true
refreshGui.Draggable = true
refreshGui.Parent = gui

Instance.new("UICorner", refreshGui)

-- bot√≥n Refresh manual
local refreshBtn = Instance.new("TextButton")
refreshBtn.Size = UDim2.new(1,-10,0,32)
refreshBtn.Position = UDim2.new(0,5,0,6)
refreshBtn.Text = "REFRESH"
refreshBtn.TextScaled = true
refreshBtn.Font = Enum.Font.SourceSansBold
refreshBtn.BackgroundColor3 = Color3.fromRGB(70,70,70)
refreshBtn.TextColor3 = Color3.new(1,1,1)
refreshBtn.Parent = refreshGui

refreshBtn.MouseButton1Click:Connect(function()
	fireRefresh()
end)

-- bot√≥n Auto ON/OFF
local autoBtn = Instance.new("TextButton")
autoBtn.Size = UDim2.new(1,-10,0,30)
autoBtn.Position = UDim2.new(0,5,0,46)
autoBtn.Text = "AUTO: OFF"
autoBtn.TextScaled = true
autoBtn.Font = Enum.Font.SourceSansBold
autoBtn.BackgroundColor3 = Color3.fromRGB(50,50,50)
autoBtn.TextColor3 = Color3.new(1,1,1)
autoBtn.Parent = refreshGui

local autoRefresh = false

autoBtn.MouseButton1Click:Connect(function()
	autoRefresh = not autoRefresh
	autoBtn.Text = autoRefresh and "AUTO: ON" or "AUTO: OFF"
end)

-- ================= LOOP AUTO REFRESH =================
-- sincronizado: primero escanea, luego refresca si NO hay server bueno

task.spawn(function()
	while true do
		if autoRefresh and not joinLock then
			-- solo refrescar si NO hay JOIN visible
			if not bigBtn.Visible then
				fireRefresh()
			end
		end
		task.wait(0.12) -- r√°pido pero estable
	end
end)

-- ================= CLEAN USADOS GUI =================

local cleanGui = Instance.new("Frame")
cleanGui.Size = UDim2.new(0,140,0,50)
cleanGui.Position = UDim2.new(0,20,0.5,-25)
cleanGui.BackgroundColor3 = Color3.fromRGB(120,30,30)
cleanGui.Active = true
cleanGui.Draggable = true
cleanGui.Parent = gui

Instance.new("UICorner", cleanGui)

local cleanBtn = Instance.new("TextButton")
cleanBtn.Size = UDim2.new(1,-10,1,-10)
cleanBtn.Position = UDim2.new(0,5,0,5)
cleanBtn.Text = "CLEAN"
cleanBtn.TextScaled = true
cleanBtn.Font = Enum.Font.SourceSansBold
cleanBtn.BackgroundColor3 = Color3.fromRGB(180,50,50)
cleanBtn.TextColor3 = Color3.new(1,1,1)
cleanBtn.Parent = cleanGui

cleanBtn.MouseButton1Click:Connect(function()
	-- limpiar tabla en memoria
	usados = {}

	-- borrar archivo si existe
	if isfile(FILE_NAME) then
		pcall(function()
			delfile(FILE_NAME)
		end)
	end

	-- refrescar UI
	escanear()

	cleanBtn.Text = "CLEANED"
	task.delay(1,function()
		cleanBtn.Text = "CLEAN"
	end)
end)































