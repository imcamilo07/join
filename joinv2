-- ================= CONFIG =================
local MAX_SERVERS_A_ESCANEAR = 5 
local MIN_JOIN_VALUE = 200e6 -- 200M m√≠nimo

-- ================= SETUP =================
local player = game.Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")
local HttpService = game:GetService("HttpService")

local petMenu
repeat
	petMenu = PlayerGui:FindFirstChild("PetMenu")
	task.wait()
until petMenu

local mainFrame = petMenu:WaitForChild("Frame")
local scrolling = mainFrame:WaitForChild("ScrollingFrame")

local usados = {} 
local joinLock = false 
local cachedRefreshBtn = nil 
local FILE_NAME = "auto_join_usados.json"

-- ================= PERSISTENCIA =================
local function cargarUsados()
	if isfile(FILE_NAME) then
		local ok, data = pcall(function() return HttpService:JSONDecode(readfile(FILE_NAME)) end)
		if ok and type(data) == "table" then usados = data end
	end
end

local function guardarUsados()
	pcall(function() writefile(FILE_NAME, HttpService:JSONEncode(usados)) end)
end

cargarUsados()

-- ================= UTILS =================
local function parseValor(txt)
	if not txt then return nil end
	local clean = string.gsub(txt, "%s+", "") 
	for num, suf in string.gmatch(clean, "([%d%.]+)([MB])") do
		local n = tonumber(num)
		if n then
			if suf == "B" then return n * 1e9 end
			if suf == "M" then return n * 1e6 end
		end
	end
	return nil
end

-- ================= GUI PRINCIPAL =================
local gui = Instance.new("ScreenGui")
gui.Name = "AUTO_JOIN_PRO_VISUAL"
gui.ResetOnSpawn = false
gui.DisplayOrder = 999999
gui.Parent = PlayerGui

-- Bot√≥n Grande de JOIN (Feedback visual)
local bigBtn = Instance.new("TextButton")
bigBtn.Size = UDim2.new(0,260,0,90)
bigBtn.Position = UDim2.new(1,-280,0.5,-45)
bigBtn.BackgroundColor3 = Color3.fromRGB(0,170,0)
bigBtn.TextColor3 = Color3.new(1,1,1)
bigBtn.TextScaled = true
bigBtn.Font = Enum.Font.SourceSansBold
bigBtn.Visible = false
bigBtn.Parent = gui

-- ================= GUI LOGS (LO QUE PEDISTE) =================
local logsFrame = Instance.new("Frame")
logsFrame.Size = UDim2.new(0,200,0,180)
logsFrame.Position = UDim2.new(0, 10, 0.5, 50) -- Abajo a la izquierda
logsFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
logsFrame.Visible = false -- Oculto por defecto
logsFrame.Parent = gui
Instance.new("UICorner", logsFrame)

local logsTitle = Instance.new("TextLabel")
logsTitle.Size = UDim2.new(1,0,0,25)
logsTitle.BackgroundTransparency = 1
logsTitle.Text = "üîç ESCANEANDO (TOP 5)"
logsTitle.TextColor3 = Color3.fromRGB(255, 200, 0)
logsTitle.Font = Enum.Font.SourceSansBold
logsTitle.TextSize = 14
logsTitle.Parent = logsFrame

local logsText = Instance.new("TextLabel")
logsText.Size = UDim2.new(1,-10,1,-30)
logsText.Position = UDim2.new(0,5,0,30)
logsText.BackgroundTransparency = 1
logsText.TextXAlignment = Enum.TextXAlignment.Left
logsText.TextYAlignment = Enum.TextYAlignment.Top
logsText.Text = "Esperando..."
logsText.TextColor3 = Color3.new(1,1,1)
logsText.Font = Enum.Font.Code
logsText.TextSize = 12
logsText.Parent = logsFrame

-- Actualizar el texto del log visual
local function updateLogs(servidores)
	local txt = ""
	for i, srv in ipairs(servidores) do
		local estado = "‚úÖ"
		if srv.usado then estado = "‚õî(Usado)" end
		if srv.valor < MIN_JOIN_VALUE then estado = "üîª(Bajo)" end
		
		txt = txt .. i .. ". " .. srv.firma .. " " .. estado .. "\n"
	end
	logsText.Text = txt
end

-- ================= CORE (LOGICA) =================

local function intentarUnirse(frame, firma)
	if joinLock then return end
	joinLock = true
	bigBtn.Visible = false

	local inner = frame:FindFirstChildWhichIsA("Frame")
	if not inner then joinLock = false return end
	local joinBtn = inner:FindFirstChildWhichIsA("TextButton")
	if not joinBtn then joinLock = false return end

	-- 1. Marcar como usado inmediatamente para no repetir
	usados[firma] = true
	task.spawn(guardarUsados)
	
	-- 2. CLICK
	for _,conn in ipairs(getconnections(joinBtn.MouseButton1Click)) do
		conn:Fire()
	end
	
	print("üöÄ INTENTO DE UNI√ìN: " .. firma)

	-- FIX: Si falla, desbloquear r√°pido
	task.delay(2.5, function()
		if joinLock then
			joinLock = false
		end
	end)
end

local function escanearSmart()
	local hijos = scrolling:GetChildren()
	local candidatos = {}
	local logsData = {} -- Para la GUI desplegable
	
	local count = 0
	for _,obj in ipairs(hijos) do
		if obj:IsA("Frame") then
			count = count + 1
			if count > MAX_SERVERS_A_ESCANEAR then break end

			local lbl = obj:FindFirstChildWhichIsA("TextLabel")
			if lbl and lbl.Text then
				local txt = lbl.Text
				local val = parseValor(txt) or 0
				local isUsed = usados[txt] ~= nil
				
				-- Guardar info para el LOG VISUAL
				table.insert(logsData, {firma = txt, valor = val, usado = isUsed})

				-- Si es v√°lido y no usado, a√±adir a candidatos
				if val >= MIN_JOIN_VALUE and not isUsed then
					table.insert(candidatos, {
						frame = obj,
						valor = val,
						firma = txt
					})
				end
			end
		end
	end
	
	-- Actualizar GUI Desplegable
	updateLogs(logsData)

	-- L√≥gica de Selecci√≥n
	if #candidatos > 0 then
		-- Ordenar de Mayor a Menor
		table.sort(candidatos, function(a,b) return a.valor > b.valor end)
		
		local mejor = candidatos[1]
		
		-- Feedback Visual
		bigBtn.Text = "JOIN " .. mejor.firma
		bigBtn.Visible = true
		
		-- AUTO JOIN
		task.defer(function()
			intentarUnirse(mejor.frame, mejor.firma)
		end)
		return true
	else
		bigBtn.Visible = false
		return false
	end
end

-- ================= TRIGGER MANUAL =================
scrolling.ChildAdded:Connect(function()
	if not joinLock then 
		-- Peque√±a espera por si llegan en bloque
		task.wait() 
		escanearSmart() 
	end
end)

-- ================= REFRESH =================

local function getRefreshBtn()
	for _,obj in ipairs(mainFrame:GetDescendants()) do
		if obj:IsA("TextButton") and (obj.Text == "Refresh" or obj.ContentText == "Refresh") then
			return obj
		end
	end
end

local function fireRefresh()
	if not cachedRefreshBtn or not cachedRefreshBtn.Parent then
		cachedRefreshBtn = getRefreshBtn()
	end
	if cachedRefreshBtn then
		for _,conn in ipairs(getconnections(cachedRefreshBtn.MouseButton1Click)) do
			conn:Fire()
		end
	end
end

-- ================= CONTROLES GUI =================

local controlPanel = Instance.new("Frame")
controlPanel.Size = UDim2.new(0,160,0,130) -- M√°s alto para el bot√≥n de logs
controlPanel.Position = UDim2.new(1,-450,0.5,-65)
controlPanel.BackgroundColor3 = Color3.fromRGB(25,25,25)
controlPanel.Active = true
controlPanel.Draggable = true
controlPanel.Parent = gui
Instance.new("UICorner", controlPanel)

-- Bot√≥n Logs
local logsBtn = Instance.new("TextButton")
logsBtn.Size = UDim2.new(1,-10,0,25)
logsBtn.Position = UDim2.new(0,5,0,5)
logsBtn.Text = "MOSTRAR LOGS: OFF"
logsBtn.BackgroundColor3 = Color3.fromRGB(200, 150, 0)
logsBtn.TextColor3 = Color3.new(1,1,1)
logsBtn.Parent = controlPanel

logsBtn.MouseButton1Click:Connect(function()
	logsFrame.Visible = not logsFrame.Visible
	logsBtn.Text = logsFrame.Visible and "MOSTRAR LOGS: ON" or "MOSTRAR LOGS: OFF"
end)

-- Bot√≥n Auto
local autoBtn = Instance.new("TextButton")
autoBtn.Size = UDim2.new(1,-10,0,40)
autoBtn.Position = UDim2.new(0,5,0,35)
autoBtn.Text = "AUTO JOIN: OFF"
autoBtn.TextScaled = true
autoBtn.BackgroundColor3 = Color3.fromRGB(150,50,50)
autoBtn.TextColor3 = Color3.new(1,1,1)
autoBtn.Font = Enum.Font.SourceSansBold
autoBtn.Parent = controlPanel

-- Bot√≥n Clean
local cleanBtn = Instance.new("TextButton")
cleanBtn.Size = UDim2.new(1,-10,0,30)
cleanBtn.Position = UDim2.new(0,5,0,80)
cleanBtn.Text = "BORRAR DATOS (CLEAN)"
cleanBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
cleanBtn.TextColor3 = Color3.new(1,1,1)
cleanBtn.Parent = controlPanel

local autoRefresh = false

autoBtn.MouseButton1Click:Connect(function()
	autoRefresh = not autoRefresh
	autoBtn.Text = autoRefresh and "AUTO JOIN: ON" or "AUTO JOIN: OFF"
	autoBtn.BackgroundColor3 = autoRefresh and Color3.fromRGB(0,150,0) or Color3.fromRGB(150,50,50)
end)

cleanBtn.MouseButton1Click:Connect(function()
	usados = {}
	if isfile(FILE_NAME) then delfile(FILE_NAME) end
	cleanBtn.Text = "¬°DATOS BORRADOS!"
	updateLogs({}) -- Limpiar visualmente
	task.delay(1, function() cleanBtn.Text = "BORRAR DATOS (CLEAN)" end)
end)

-- ================= LOOP INTELIGENTE =================

task.spawn(function()
	while true do
		if autoRefresh and not joinLock then
			
			-- 1. Disparar Refresh
			fireRefresh()
			
			-- 2. SMART WAIT: Esperar hasta ver botones o Timeout
			-- Esto hace que espere solo lo necesario. Si el celu es r√°pido, es r√°pido.
			local start = tick()
			local items = 0
			
			repeat 
				items = 0
				for _,c in ipairs(scrolling:GetChildren()) do
					if c:IsA("Frame") then items = items + 1 end
				end
				task.wait() -- Check ultra r√°pido
			until items >= MAX_SERVERS_A_ESCANEAR or (tick() - start) > 0.4 -- Max espera 0.4s
			
			-- Peque√±a estabilizaci√≥n final (0.05s) para que el texto cargue
			task.wait(0.05)
			
			-- 3. Escanear
			escanearSmart()
		end
		
		-- Pausa m√≠nima antes del siguiente refresh
		task.wait(0.05)
	end
end)
